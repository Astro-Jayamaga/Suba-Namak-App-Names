<!DOCTYPE html>
<html lang="en" class="dark"> <!-- Default to dark mode -->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weather Forecast Sri Lanka</title>
    
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Load Inter font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Configure Tailwind for 'class' dark mode and custom brand colors -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        brand: {
                            navy: '#020d47',
                            maroon: '#8e163c',
                        }
                    }
                }
            }
        }
    </script>
    
    <style>
        /* Use Inter as the default font */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Simple spinning animation for the loader */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .loader {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top-color: #fff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        
        /* Dark mode loader */
        html.dark .loader {
             border: 4px solid rgba(255, 255, 255, 0.3);
             border-top-color: #fff;
        }
        
        /* Light mode loader */
        html:not(.dark) .loader {
            border: 4px solid rgba(0, 0, 0, 0.2);
            border-top-color: #020d47; /* Brand navy */
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-brand-navy text-gray-900 dark:text-white min-h-screen antialiased transition-colors duration-300">

    <!-- Main Container -->
    <div class="container mx-auto max-w-5xl p-4 md:p-8 pb-12"> <!-- Added pb-12 for 3rem bottom space -->
        
        <header class="mb-8 flex justify-between items-center">
            <div>
                <h1 class="text-3xl md:text-4xl font-bold text-brand-maroon dark:text-blue-300">Weather Forecast Sri Lanka</h1>
                <p id="main-location" class="text-lg text-gray-700 dark:text-gray-300 mt-2">Colombo, Sri Lanka</p>
            </div>
            
            <!-- Theme Toggle Button -->
            <button id="theme-toggle" class="p-2 rounded-full text-brand-maroon dark:text-blue-300 bg-gray-200 dark:bg-white/10 hover:bg-gray-300 dark:hover:bg-white/20 transition-colors">
                <!-- Sun Icon (Default for dark mode) -->
                <svg id="theme-icon-sun" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
                </svg>
                <!-- Moon Icon (Hidden by default) -->
                <svg id="theme-icon-moon" class="h-6 w-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
                </svg>
            </button>
        </header>

        <!-- Loading Spinner -->
        <div id="loading" class="flex flex-col items-center justify-center p-16">
            <div class="loader"></div>
            <p class="mt-4 text-gray-600 dark:text-gray-400">Fetching latest weather data...</p>
        </div>

        <!-- Error Message -->
        <div id="error" class="hidden bg-red-100 dark:bg-red-800 border border-red-300 dark:border-red-600 text-red-700 dark:text-red-100 px-4 py-3 rounded-lg text-center" role="alert">
            <strong class="font-bold">Error:</strong>
            <span id="error-message" class="block sm:inline"></span>
        </div>

        <!-- Weather Content (Hidden by default) -->
        <div id="weather-content" class="hidden space-y-10">
            
            <!-- Current Weather Section -->
            <section id="current-weather" class="bg-white dark:bg-white/10 rounded-2xl p-6 md:p-8 shadow-xl backdrop-blur-md border border-gray-200 dark:border-white/20">
                <h2 class="text-2xl font-semibold mb-6 text-gray-800 dark:text-gray-100">Current Conditions</h2>
                <div class="flex flex-col md:flex-row items-center justify-between gap-8">
                    
                    <!-- Current Temp & Icon -->
                    <div class="flex items-center gap-4">
                        <div id="current-icon" class="text-6xl md:text-7xl"></div>
                        <div>
                            <div id="current-temp" class="text-5xl md:text-6xl font-bold"></div>
                            <div id="current-description" class="text-lg text-gray-700 dark:text-gray-300"></div>
                        </div>
                    </div>

                    <!-- Current Details Grid -->
                    <div class="grid grid-cols-2 sm:grid-cols-3 gap-x-6 gap-y-5 text-lg w-full md:w-auto">
                        <div class="flex flex-col">
                            <span class="text-sm text-gray-500 dark:text-gray-400">Feels Like</span>
                            <span id="current-feels-like" class="font-semibold text-xl"></span>
                        </div>
                        <div class="flex flex-col">
                            <span class="text-sm text-gray-500 dark:text-gray-400">Humidity</span>
                            <span id="current-humidity" class="font-semibold text-xl"></span>
                        </div>
                        <div class="flex flex-col">
                            <span class="text-sm text-gray-500 dark:text-gray-400">Wind</span>
                            <span id="current-wind" class="font-semibold text-xl"></span>
                        </div>
                         <div class="flex flex-col">
                            <span class="text-sm text-gray-500 dark:text-gray-400">Precipitation</span>
                            <span id="current-precipitation" class="font-semibold text-xl"></span>
                        </div>
                        <div class="flex flex-col">
                            <span class="text-sm text-gray-500 dark:text-gray-400">UV Index</span>
                            <span id="current-uv" class="font-semibold text-xl"></span>
                        </div>
                        <div class="flex flex-col">
                            <span class="text-sm text-gray-500 dark:text-gray-400">Last Updated</span>
                            <span id="current-time" class="font-semibold text-xl"></span>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 7-Day Forecast Section -->
            <section id="daily-forecast">
                <h2 class="text-2xl font-semibold mb-6 text-gray-800 dark:text-gray-100">7-Day Forecast</h2>
                <div id="forecast-grid" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-4">
                    <!-- Forecast cards will be injected here by JavaScript -->
                </div>
            </section>

            <!-- District Report Section -->
            <section id="district-report">
                <h2 class="text-2xl font-semibold mb-6 text-gray-800 dark:text-gray-100">Current Weather Across Sri Lanka</h2>
                <div class="overflow-x-auto bg-white dark:bg-white/10 rounded-2xl shadow-xl border border-gray-200 dark:border-white/20">
                    <table class="w-full min-w-[600px] text-left">
                        <thead class="border-b border-gray-200 dark:border-white/20">
                            <tr class="text-sm text-gray-600 dark:text-gray-300">
                                <th class="p-4 font-semibold">District</th>
                                <th class="p-4 font-semibold">Condition</th>
                                <th class="p-4 font-semibold">Temp.</th>
                                <th class="p-4 font-semibold">Feels Like</th>
                                <th class="p-4 font-semibold">Wind (km/h)</th>
                                <th class="p-4 font-semibold">Humidity</th>
                            </tr>
                        </thead>
                        <tbody id="district-table-body" class="divide-y divide-gray-200 dark:divide-white/10">
                            <!-- District rows will be injected here -->
                        </tbody>
                    </table>
                </div>
            </section>

        </div>

        <!-- Footer -->
        <footer class="text-center text-gray-600 dark:text-gray-400 mt-12">
            <p>&copy; <span id="copyright-year"></span> Weather Forecast Sri Lanka. All rights reserved.</p>
        </footer>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            setupTheme();
            fetchAllWeather();
            
            // Set dynamic copyright year
            document.getElementById('copyright-year').textContent = new Date().getFullYear();
        });

        // === DOM Elements ===
        const loadingEl = document.getElementById('loading');
        const errorEl = document.getElementById('error');
        const errorMessageEl = document.getElementById('error-message');
        const weatherContentEl = document.getElementById('weather-content');
        const themeToggleBtn = document.getElementById('theme-toggle');
        const themeIconSun = document.getElementById('theme-icon-sun');
        const themeIconMoon = document.getElementById('theme-icon-moon');

        // Current Weather Elements
        const currentIconEl = document.getElementById('current-icon');
        const currentTempEl = document.getElementById('current-temp');
        const currentDescriptionEl = document.getElementById('current-description');
        const currentFeelsLikeEl = document.getElementById('current-feels-like');
        const currentHumidityEl = document.getElementById('current-humidity');
        const currentWindEl = document.getElementById('current-wind');
        const currentPrecipitationEl = document.getElementById('current-precipitation');
        const currentUvEl = document.getElementById('current-uv');
        const currentTimeEl = document.getElementById('current-time');

        // Forecast Element
        const forecastGridEl = document.getElementById('forecast-grid');
        
        // District Table Element
        const districtTableBodyEl = document.getElementById('district-table-body');

        // === Theme Toggle ===
        function setupTheme() {
            const savedTheme = localStorage.getItem('theme') || 'dark'; // Default to dark
            
            if (savedTheme === 'dark') {
                document.documentElement.classList.add('dark');
                themeIconSun.classList.remove('hidden');
                themeIconMoon.classList.add('hidden');
            } else {
                document.documentElement.classList.remove('dark');
                themeIconSun.classList.add('hidden');
                themeIconMoon.classList.remove('hidden');
            }

            themeToggleBtn.addEventListener('click', () => {
                if (document.documentElement.classList.toggle('dark')) {
                    // Is now dark
                    localStorage.setItem('theme', 'dark');
                    themeIconSun.classList.remove('hidden');
                    themeIconMoon.classList.add('hidden');
                } else {
                    // Is now light
                    localStorage.setItem('theme', 'light');
                    themeIconSun.classList.add('hidden');
                    themeIconMoon.classList.remove('hidden');
                }
            });
        }
        
        // === Weather Data ===
        
        // Coordinates for main forecast (Colombo)
        const mainLocation = { name: 'Colombo', lat: 6.9271, lon: 79.8612 };

        // List of districts for the report
        const districts = [
            { name: 'Colombo', lat: 6.9271, lon: 79.8612 },
            { name: 'Galle', lat: 6.0535, lon: 80.2210 },
            { name: 'Kandy', lat: 7.2906, lon: 80.6337 },
            { name: 'Jaffna', lat: 9.6615, lon: 80.0255 },
            { name: 'Trincomalee', lat: 8.5874, lon: 81.2152 },
            { name: 'Anuradhapura', lat: 8.3114, lon: 80.4037 },
            { name: 'Nuwara Eliya', lat: 6.9497, lon: 80.7891 },
            { name: 'Batticaloa', lat: 7.7218, lon: 81.6963 }
        ];

        /**
         * Fetches all required weather data in parallel
         */
        async function fetchAllWeather() {
            try {
                // Show loading, hide others
                loadingEl.style.display = 'flex';
                errorEl.style.display = 'none';
                weatherContentEl.style.display = 'none';

                // Create all fetch promises
                const mainForecastPromise = fetchMainForecast(mainLocation.lat, mainLocation.lon);
                const districtReportPromise = fetchDistrictReport();

                // Await all data
                const [mainData, districtData] = await Promise.all([mainForecastPromise, districtReportPromise]);

                // Display main forecast
                if (mainData && mainData.current && mainData.daily) {
                    displayCurrentWeather(mainData.current, mainData.daily, mainData.timezone);
                    displayDailyForecast(mainData.daily);
                } else {
                    throw new Error('Invalid main forecast data.');
                }
                
                // Display district report
                if (districtData && districtData.length > 0) {
                    displayDistrictReport(districtData);
                } else {
                    throw new Error('Invalid district report data.');
                }

                // Show weather, hide loading
                loadingEl.style.display = 'none';
                weatherContentEl.style.display = 'block';

            } catch (error) {
                console.error('Error fetching weather:', error);
                showError(`Failed to fetch weather data. ${error.message}`);
            }
        }
        
        /**
         * Fetches the 7-day and current forecast for the main location
         */
        async function fetchMainForecast(latitude, longitude) {
            const currentParams = 'temperature_2m,relative_humidity_2m,apparent_temperature,is_day,precipitation,weather_code,wind_speed_10m';
            const dailyParams = 'weather_code,temperature_2m_max,temperature_2m_min,uv_index_max,precipitation_probability_max';
            const apiUrl = `https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&current=${currentParams}&daily=${dailyParams}&timezone=Asia%2FColombo&forecast_days=7`;

            const response = await fetch(apiUrl);
            if (!response.ok) throw new Error(`API request failed: ${response.status}`);
            return response.json();
        }

        /**
         * Fetches current weather for all districts
         */
        async function fetchDistrictReport() {
            const districtPromises = districts.map(district => 
                fetchSingleDistrict(district.lat, district.lon).then(data => ({
                    name: district.name,
                    ...data.current // Add all current data to the district object
                }))
            );
            return Promise.all(districtPromises);
        }

        /**
         * Helper to fetch *only current* weather for a single location
         */
        async function fetchSingleDistrict(latitude, longitude) {
            const currentParams = 'temperature_2m,relative_humidity_2m,apparent_temperature,is_day,weather_code,wind_speed_10m';
            const apiUrl = `https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&current=${currentParams}&timezone=Asia%2FColombo`;
            
            const response = await fetch(apiUrl);
            if (!response.ok) throw new Error(`API request failed for district: ${response.status}`);
            return response.json();
        }

        /**
         * Displays the current weather data
         */
        function displayCurrentWeather(current, daily, timezone) {
            const weatherInfo = getWeatherInfo(current.weather_code, current.is_day);

            currentIconEl.textContent = weatherInfo.icon;
            currentTempEl.textContent = `${Math.round(current.temperature_2m)}¬∞C`;
            currentDescriptionEl.textContent = weatherInfo.description;
            
            currentFeelsLikeEl.textContent = `${Math.round(current.apparent_temperature)}¬∞C`;
            currentHumidityEl.textContent = `${current.relative_humidity_2m}%`;
            currentWindEl.textContent = `${Math.round(current.wind_speed_10m)} km/h`;
            
            // Get today's data from the daily forecast (index 0)
            currentPrecipitationEl.textContent = `${daily.precipitation_probability_max[0]}%`;
            currentUvEl.textContent = `${Math.round(daily.uv_index_max[0])}`;

            // *** FIX: Use ISO string from 'current.time' to create Date object ***
            const updateTime = new Date(current.time); 
            currentTimeEl.textContent = updateTime.toLocaleTimeString('en-US', {
                hour: '2-digit',
                minute: '2-digit',
                timeZone: timezone
            });
        }

        /**
         * Displays the 7-day forecast
         */
        function displayDailyForecast(daily) {
            forecastGridEl.innerHTML = ''; // Clear previous forecast

            daily.time.forEach((dateString, index) => {
                const weatherInfo = getWeatherInfo(daily.weather_code[index], true); // Assume day for forecast icon
                const date = new Date(dateString);
                
                // *** NEW: Format day and date number ***
                const day = date.toLocaleDateString('en-US', { weekday: 'short' });
                const dateNum = date.getDate();
                
                const card = document.createElement('div');
                card.className = 'bg-white dark:bg-white/10 rounded-xl p-4 flex flex-col items-center gap-1 text-center shadow-lg border border-gray-200 dark:border-white/20';
                
                card.innerHTML = `
                    <div class="font-semibold text-lg text-brand-maroon dark:text-blue-300">${day}</div>
                    <div class="text-gray-700 dark:text-gray-300 text-lg">${dateNum}</div>
                    <div class="text-4xl my-2">${weatherInfo.icon}</div>
                    <div class="text-sm text-gray-700 dark:text-gray-300 h-10">${weatherInfo.description}</div>
                    <div class="text-lg font-semibold mt-2">
                        <span class="text-gray-900 dark:text-white">${Math.round(daily.temperature_2m_max[index])}¬∞</span>
                        <span class="text-gray-500 dark:text-gray-400">${Math.round(daily.temperature_2m_min[index])}¬∞</span>
                    </div>
                    <div class="text-sm text-gray-700 dark:text-blue-300 mt-1">
                        <span class="text-gray-500 dark:text-gray-400">Rain:</span> ${daily.precipitation_probability_max[index]}%
                    </div>
                `;
                
                forecastGridEl.appendChild(card);
            });
        }

        /**
         * Displays the district weather report in a table
         */
        function displayDistrictReport(districtData) {
            districtTableBodyEl.innerHTML = ''; // Clear previous data
            
            districtData.forEach(data => {
                const weatherInfo = getWeatherInfo(data.weather_code, data.is_day);
                
                const row = document.createElement('tr');
                row.className = 'text-base';
                row.innerHTML = `
                    <td class="p-4 font-semibold">${data.name}</td>
                    <td class="p-4">
                        <span class="mr-2 text-2xl">${weatherInfo.icon}</span>
                        <span>${weatherInfo.description}</span>
                    </td>
                    <td class="p-4 font-semibold">${Math.round(data.temperature_2m)}¬∞C</td>
                    <td class="p-4">${Math.round(data.apparent_temperature)}¬∞C</td>
                    <td class="p-4">${Math.round(data.wind_speed_10m)}</td>
                    <td class="p-4">${data.relative_humidity_2m}%</td>
                `;
                districtTableBodyEl.appendChild(row);
            });
        }

        /**
         * Maps WMO weather code to description and emoji icon
         */
        function getWeatherInfo(code, isDay) {
            const icons = {
                day: {
                    0: { description: 'Clear sky', icon: '‚òÄÔ∏è' }, 1: { description: 'Mainly clear', icon: 'üå§Ô∏è' },
                    2: { description: 'Partly cloudy', icon: '‚õÖÔ∏è' }, 3: { description: 'Overcast', icon: '‚òÅÔ∏è' },
                    45: { description: 'Fog', icon: 'üå´Ô∏è' }, 48: { description: 'Rime fog', icon: 'üå´Ô∏è' },
                    51: { description: 'Light drizzle', icon: 'üå¶Ô∏è' }, 53: { description: 'Drizzle', icon: 'üå¶Ô∏è' },
                    55: { description: 'Dense drizzle', icon: 'üå¶Ô∏è' }, 61: { description: 'Slight rain', icon: 'üåßÔ∏è' },
                    63: { description: 'Rain', icon: 'üåßÔ∏è' }, 65: { description: 'Heavy rain', icon: 'üåßÔ∏è' },
                    80: { description: 'Slight showers', icon: 'üåßÔ∏è' }, 81: { description: 'Rain showers', icon: 'üåßÔ∏è' },
                    82: { description: 'Violent showers', icon: 'üåßÔ∏è' }, 95: { description: 'Thunderstorm', icon: '‚õàÔ∏è' },
                    96: { description: 'Thunderstorm', icon: '‚õàÔ∏è' }, 99: { description: 'Thunderstorm', icon: '‚õàÔ∏è' }
                },
                night: {
                    0: { description: 'Clear sky', icon: 'üåô' }, 1: { description: 'Mainly clear', icon: '‚òÅÔ∏è' },
                    2: { description: 'Partly cloudy', icon: '‚òÅÔ∏è' }, 3: { description: 'Overcast', icon: '‚òÅÔ∏è' }
                }
            };
            const iconSet = isDay ? icons.day : icons.night;
            return iconSet[code] || icons.day[code] || { description: 'Unknown', icon: 'ü§∑' };
        }

        /**
         * Displays an error message
         */
        function showError(message) {
            loadingEl.style.display = 'none';
            weatherContentEl.style.display = 'none';
            errorEl.style.display = 'block';
            errorMessageEl.textContent = message;
        }

    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Compass Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            touch-action: none;
            overscroll-behavior: none;
        }
        .compass-dial {
            transition: transform 0.2s ease-out;
        }
        .compass-container::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 10px;
            height: 10px;
            background-color: #f87171; /* Red-400 */
            border-radius: 50%;
            z-index: 20;
            border: 2px solid #1f2937; /* Gray-800 */
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 flex items-center justify-center min-h-screen antialiased select-none">
    
    <div id="permission-modal" class="absolute inset-0 bg-gray-900 bg-opacity-90 flex flex-col items-center justify-center z-50 p-4">
        <div class="text-center">
            <svg class="mx-auto h-16 w-16 text-sky-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <h2 class="text-3xl font-bold text-white mt-4">Advanced Compass</h2>
            <p class="text-gray-400 mt-2 max-w-sm">Please grant permission to access device orientation and location for the compass and GPS to function.</p>
            <button id="start-btn" class="mt-8 bg-sky-500 hover:bg-sky-600 text-white font-bold py-3 px-8 rounded-lg shadow-lg transition-transform transform hover:scale-105">
                Start Compass
            </button>
            <p id="error-message" class="text-red-400 mt-4 h-5"></p>
        </div>
    </div>

    <div class="w-full max-w-sm mx-auto p-4 space-y-6">
        <!-- Header: Time and Date -->
        <div class="text-center">
            <h1 id="time-display" class="text-4xl font-bold text-white tracking-wider">00:00:00</h1>
            <p id="date-display" class="text-gray-400">Monday, January 1</p>
        </div>

        <!-- Compass -->
        <div class="relative w-80 h-80 mx-auto compass-container">
            <!-- Compass Needle (Static) -->
            <div class="absolute inset-0 flex justify-center z-10">
                <svg width="24" height="320" viewBox="0 0 24 320" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 0L22 28L12 320L2 28L12 0Z" fill="#f87171"/> <!-- Red-400 -->
                    <path d="M12 0L2 28L12 320L22 28L12 0Z" fill="#ef4444" fill-opacity="0.5"/> <!-- Red-500 -->
                </svg>
            </div>
            <!-- Compass Dial (Rotates) -->
            <div id="compass-dial" class="w-full h-full rounded-full bg-gray-800 shadow-2xl compass-dial flex items-center justify-center relative border-4 border-gray-700">
                <img src="https://placehold.co/300x300/1f2937/a3a3a3?text=%20"
                     onerror="this.onerror=null;this.src='https://placehold.co/300x300/1f2937/4b5563?text=Compass'"
                     alt="Compass Dial"
                     class="absolute w-full h-full object-cover rounded-full dial-image-placeholder">
            </div>
        </div>

        <!-- Digital Readout -->
        <div class="bg-gray-800 p-4 rounded-xl shadow-lg text-center">
            <h2 id="heading-display" class="text-5xl font-bold text-sky-400">0°</h2>
            <p id="direction-display" class="text-2xl text-gray-300 font-medium">N</p>
        </div>
        
        <!-- GPS Coordinates -->
        <div class="bg-gray-800 p-4 rounded-xl shadow-lg flex justify-around text-center">
            <div>
                <p class="text-xs text-gray-400 uppercase tracking-widest">Latitude</p>
                <p id="lat-display" class="text-lg font-semibold text-white">--.------</p>
            </div>
            <div>
                <p class="text-xs text-gray-400 uppercase tracking-widest">Longitude</p>
                <p id="lon-display" class="text-lg font-semibold text-white">--.------</p>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // DOM Elements
            const startBtn = document.getElementById('start-btn');
            const permissionModal = document.getElementById('permission-modal');
            const errorMessage = document.getElementById('error-message');
            const compassDial = document.getElementById('compass-dial');
            const headingDisplay = document.getElementById('heading-display');
            const directionDisplay = document.getElementById('direction-display');
            const latDisplay = document.getElementById('lat-display');
            const lonDisplay = document.getElementById('lon-display');
            const timeDisplay = document.getElementById('time-display');
            const dateDisplay = document.getElementById('date-display');
            const dialImage = document.querySelector('.dial-image-placeholder');

            let smoothedHeading = 0;
            const smoothingFactor = 0.1;

            // Generate compass dial SVG
            const generateCompassDialSVG = () => {
                const svgNS = "http://www.w3.org/2000/svg";
                let svg = `<svg viewBox="0 0 300 300" xmlns="${svgNS}">`;
                svg += `<circle cx="150" cy="150" r="148" fill="#1f2937" stroke="#4b5563" stroke-width="2"/>`; // Gray-800, Gray-600
                const directions = {
                    'N': 0, 'E': 90, 'S': 180, 'W': 270
                };
                for (let i = 0; i < 360; i += 2) {
                    const angle = i * Math.PI / 180;
                    const isMajor = i % 30 === 0;
                    const isCardinal = i % 90 === 0;
                    const r1 = isCardinal ? 120 : (isMajor ? 130 : 138);
                    const r2 = 145;
                    const x1 = 150 + r1 * Math.sin(angle);
                    const y1 = 150 - r1 * Math.cos(angle);
                    const x2 = 150 + r2 * Math.sin(angle);
                    const y2 = 150 - r2 * Math.cos(angle);
                    svg += `<line x1="${x1}" y1="${y1}" x2="${x2}" y2="${y2}" stroke="${isMajor ? '#e5e7eb' : '#6b7280'}" stroke-width="${isMajor ? 2 : 1}"/>`;
                }
                Object.entries(directions).forEach(([dir, angleDeg]) => {
                    const angleRad = angleDeg * Math.PI / 180;
                    const r = 105;
                    const x = 150 + r * Math.sin(angleRad);
                    const y = 150 - r * Math.cos(angleRad) + 8;
                    svg += `<text x="${x}" y="${y}" font-family="Inter, sans-serif" font-size="24" font-weight="bold" fill="#e5e7eb" text-anchor="middle">${dir}</text>`;
                });
                svg += '</svg>';
                return `data:image/svg+xml;base64,${btoa(svg)}`;
            };

            dialImage.src = generateCompassDialSVG();

            // --- Permission and Initialization ---
            startBtn.addEventListener('click', async () => {
                try {
                    // Request Device Orientation
                    if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                        const permission = await DeviceOrientationEvent.requestPermission();
                        if (permission === 'granted') {
                            window.addEventListener('deviceorientation', handleOrientation);
                        } else {
                            throw new Error('Device orientation permission denied.');
                        }
                    } else {
                        // For non-iOS 13+ devices
                        window.addEventListener('deviceorientation', handleOrientation);
                    }

                    // Request Geolocation
                    if ('geolocation' in navigator) {
                        navigator.geolocation.watchPosition(handleLocation, handleLocationError, {
                            enableHighAccuracy: true
                        });
                    } else {
                        throw new Error('Geolocation is not supported by your browser.');
                    }
                    
                    permissionModal.style.display = 'none';
                    
                } catch (error) {
                    errorMessage.textContent = error.message;
                    console.error(error);
                }
            });

            // --- Event Handlers ---
            const handleOrientation = (event) => {
                let heading = event.webkitCompassHeading || (360 - event.alpha);
                
                if (typeof heading === 'undefined' || heading === null) return;
                
                // Correct for screen orientation
                const orientation = window.orientation || 0;
                heading -= orientation;
                if (heading < 0) heading += 360;

                // Smoothing the heading value to reduce jitter
                smoothedHeading = (heading * smoothingFactor) + (smoothedHeading * (1 - smoothingFactor));

                updateCompass(smoothedHeading);
            };

            const handleLocation = (position) => {
                const { latitude, longitude } = position.coords;
                latDisplay.textContent = latitude.toFixed(6);
                lonDisplay.textContent = longitude.toFixed(6);
            };

            const handleLocationError = (error) => {
                let msg = 'Location error.';
                switch(error.code) {
                    case error.PERMISSION_DENIED:
                        msg = "Location access denied.";
                        break;
                    case error.POSITION_UNAVAILABLE:
                        msg = "Location unavailable.";
                        break;
                    case error.TIMEOUT:
                        msg = "Location request timed out.";
                        break;
                }
                latDisplay.textContent = msg;
                lonDisplay.textContent = '';
                console.warn(`LOCATION ERROR(${error.code}): ${error.message}`);
            };

            // --- UI Update Functions ---
            const updateCompass = (heading) => {
                const roundedHeading = Math.round(heading);
                compassDial.style.transform = `rotate(-${heading}deg)`;
                headingDisplay.textContent = `${roundedHeading}°`;
                directionDisplay.textContent = degreesToCardinal(roundedHeading);
            };

            const updateTime = () => {
                const now = new Date();
                timeDisplay.textContent = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false });
                dateDisplay.textContent = now.toLocaleDateString([], { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            };

            // --- Helper Functions ---
            const degreesToCardinal = (deg) => {
                const directions = ['N', 'NNE', 'NE', 'ENE', 'E', 'ESE', 'SE', 'SSE', 'S', 'SSW', 'SW', 'WSW', 'W', 'WNW', 'NW', 'NNW'];
                const index = Math.round((deg % 360) / 22.5);
                return directions[index % 16];
            };

            // --- Initial Setup ---
            setInterval(updateTime, 1000);
            updateTime();
        });
    </script>
</body>
</html>

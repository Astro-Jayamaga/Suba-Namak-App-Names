<!DOCTYPE html>
<html lang="si">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>සුබ නම් තැබීම | Astro Jayamaga</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Gemunu+Libre:wght@400;700&family=Noto+Serif+Sinhala:wght@400;500;600;700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary-color: #7F0000; /* Maroon */
            --primary-light: #a33333;
            --secondary-color: #FDF5E6; /* Cream */
            --accent-color: #FFA500; /* Orange */
            --text-color: #333333;
            --white: #ffffff;
            --border-color: #e0e0e0;
            --success-color: #155724;
            --success-bg: #d4edda;
            --error-color: #c0392b;
            --error-bg: #fadbd8;
            --shadow: 0 8px 20px rgba(0,0,0,0.08);
            --radius: 12px;
        }

        * { box-sizing: border-box; outline: none; }

        body {
            font-family: 'Noto Serif Sinhala', serif;
            background-color: var(--secondary-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .main-container {
            width: 100%;
            max-width: 650px;
            background: var(--white);
            padding: 30px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            border-top: 6px solid var(--primary-color);
        }

        /* Typography */
        h1.main-title {
            font-family: 'Gemunu Libre', sans-serif;
            color: var(--primary-color);
            font-size: 2.4rem;
            text-align: center;
            margin-bottom: 35px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        h2.secondary-title {
            font-family: 'Noto Serif Sinhala', serif;
            font-size: 1.2rem;
            color: #444;
            background: #f8f9fa;
            padding: 10px 15px;
            border-radius: 6px;
            margin-top: 30px;
            margin-bottom: 15px;
            border-left: 4px solid var(--accent-color);
            font-weight: 700;
        }

        label {
            display: block;
            margin-bottom: 0; 
            font-weight: 600;
            color: #555;
            font-size: 0.95rem;
        }

        /* Input Group */
        .input-group { margin-bottom: 25px; }

        .label-row {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }

        /* Modern Info Icon */
        .info-icon-btn {
            background-color: var(--secondary-color);
            border: 2px solid var(--accent-color);
            color: var(--accent-color);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Roboto', sans-serif;
            font-weight: bold;
            font-size: 14px;
            cursor: pointer;
            margin-left: 10px;
            transition: all 0.2s ease;
        }

        .info-icon-btn:hover {
            background-color: var(--accent-color);
            color: white;
            transform: scale(1.1);
        }

        /* Info Box */
        .info-box {
            display: none;
            background-color: #fff8e1;
            border-left: 4px solid var(--accent-color);
            padding: 12px;
            margin-bottom: 15px;
            font-size: 0.9rem;
            color: #5d4037;
            border-radius: 4px;
            line-height: 1.5;
            animation: fadeIn 0.3s ease;
        }

        /* Inputs */
        input[type="text"], select {
            width: 100%;
            padding: 14px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-family: 'Noto Serif Sinhala', serif;
            font-size: 1rem;
            transition: all 0.3s ease;
            background-color: #fff;
        }

        input[type="text"]:focus, select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(127, 0, 0, 0.1);
        }

        /* Large Preview Style */
        .sinhala-preview-large {
            margin-top: 10px;
            font-size: 1.2rem;
            font-weight: 600;
            color: #999;
            padding: 12px;
            background-color: #f9f9f9;
            border-radius: 6px;
            border: 1px dashed #ccc;
            min-height: 50px;
            display: flex;
            align-items: center;
            transition: all 0.3s;
        }

        .preview-active {
            color: var(--primary-color);
            background-color: #fff5f5;
            border-style: solid;
            border-color: #ffcccc;
        }

        .info-tooltip {
            font-size: 0.8rem;
            color: #666;
            margin-top: 5px;
            display: block;
            font-style: italic;
        }

        /* CTA Button */
        .btn-cta {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-light) 100%);
            color: var(--white);
            font-family: 'Gemunu Libre', sans-serif;
            font-size: 1.5rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-top: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .btn-cta:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }

        .btn-cta:active { transform: scale(0.98); }

        /* Error Messages */
        .error-message {
            background-color: var(--error-bg);
            color: var(--error-color);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            margin-top: 20px;
            display: none;
            border: 1px solid #f5c6cb;
            font-weight: 600;
        }

        /* Results Section */
        .results-container {
            display: none;
            margin-top: 30px;
            animation: fadeIn 0.6s ease;
        }

        /* Main Result Box Styling (NEW) */
        .main-result-box {
            text-align: center;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            animation: fadeIn 0.8s ease;
            border: 2px solid transparent;
        }

        .main-result-text {
            font-family: 'Gemunu Libre', sans-serif;
            font-size: 2rem;
            font-weight: 700;
            margin: 0;
            line-height: 1.4;
        }

        .main-result-score {
            font-family: 'Roboto', sans-serif;
            font-size: 1rem;
            margin-top: 5px;
            opacity: 0.9;
            font-weight: 500;
        }

        /* Theme Colors */
        .theme-blue { background-color: #e3f2fd; color: #0d47a1; border-color: #bbdefb; }
        .theme-green { background-color: #e8f5e9; color: #1b5e20; border-color: #c8e6c9; }
        .theme-yellow { background-color: #fffde7; color: #f57f17; border-color: #fff9c4; }
        .theme-brown { background-color: #efebe9; color: #5d4037; border-color: #d7ccc8; }
        .theme-red { background-color: #ffebee; color: #b71c1c; border-color: #ffcdd2; }

        /* Standard Result Box */
        .result-box, .svara-vedha-box {
            background: #fff;
            border: 1px solid #eee;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .result-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px dashed #eee;
            align-items: center;
        }
        .result-row:last-child { border-bottom: none; }

        .result-label { font-weight: 600; color: #555; flex: 1; }
        .result-value { flex: 1.5; text-align: right; font-weight: 600; font-size: 1.05rem; }

        .status-good { color: var(--success-color) !important; }
        .status-bad { color: var(--error-color) !important; }

        .gana-header, .svara-header {
            text-align: center;
            font-size: 1.4rem;
            font-weight: 700;
            margin-bottom: 20px;
            padding: 15px;
            border-radius: 8px;
        }
        
        .gana-good, .svara-good {
            background-color: var(--success-bg);
            color: var(--success-color);
            border: 1px solid #c3e6cb;
        }

        .gana-bad, .svara-bad {
            background-color: var(--error-bg);
            color: var(--error-color);
            border: 1px solid #f5c6cb;
        }

        .akshara-visthara {
            font-family: 'Roboto', sans-serif;
            letter-spacing: 1px;
            background: #f1f3f5;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.9rem;
            color: #495057;
        }

        footer {
            margin-top: auto;
            margin-bottom: 2rem;
            text-align: center;
            color: #888;
            font-size: 0.85rem;
            font-family: 'Roboto', sans-serif;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @media (max-width: 480px) {
            .main-container { padding: 20px; width: 100%; }
            h1.main-title { font-size: 2rem; }
            .result-row { font-size: 0.95rem; }
            .btn-cta { font-size: 1.3rem; }
        }
    </style>
</head>
<body>

    <div class="main-container">
        <h1 class="main-title">සුබ නම් තැබීම</h1>

        <div class="input-group">
            <div class="label-row">
                <label for="nameInput">ජන්මයාගේ නම</label>
                <button type="button" class="info-icon-btn" onclick="toggleInfo()" title="උදව්">i</button>
            </div>

            <div id="nameInfoBox" class="info-box">
                උපරිම වචන 3ක් සහ එක් වචනයක් සඳහා අකුරු 12ක් පමණක් භාවිතා කරන්න. (උදා: සවින් ගිම්සර)
            </div>

            <input type="text" id="nameInput" placeholder="නම ඇතුළත් කරන්න (Singlish වලින් ටයිප් කරන්න)" autocomplete="off">
            
            <div id="sinhalaPreview" class="sinhala-preview-large">සිංහල නම මෙතැනින් දිස්වේ >></div>
            
        </div>

        <div class="input-group">
            <label for="nekatha">උපන් නැකත</label>
            <select id="nekatha">
                <option value="" disabled selected>නැකත තෝරන්න...</option>
                <option value="අස්විද">අස්විද</option>
                <option value="බෙරණ">බෙරණ</option>
                <option value="කැති">කැති</option>
                <option value="රෙහෙණ">රෙහෙණ</option>
                <option value="මුවසිරස">මුවසිරස</option>
                <option value="අද">අද</option>
                <option value="පුනාවස">පුනාවස</option>
                <option value="පුෂ">පුෂ</option>
                <option value="අස්ලිස">අස්ලිස</option>
                <option value="මා">මා</option>
                <option value="පුවපල්">පුවපල්</option>
                <option value="උත්‍රපල්">උත්‍රපල්</option>
                <option value="හත">හත</option>
                <option value="සිත">සිත</option>
                <option value="සා">සා</option>
                <option value="විසා">විසා</option>
                <option value="අනුර">අනුර</option>
                <option value="දෙට">දෙට</option>
                <option value="මුල">මුල</option>
                <option value="පුවසල">පුවසල</option>
                <option value="උත්‍රසල">උත්‍රසල</option>
                <option value="සුවණ">සුවණ</option>
                <option value="දෙනට">දෙනට</option>
                <option value="සියාවස">සියාවස</option>
                <option value="පුවපුටුප">පුවපුටුප</option>
                <option value="උත්‍රපුටුප">උත්‍රපුටුප</option>
                <option value="රේවතී">රේවතී</option>
            </select>
        </div>

        <div class="input-group">
            <label for="lagnaya">උපන් ලග්නය</label>
            <select id="lagnaya">
                <option value="" disabled selected>ලග්නය තෝරන්න...</option>
                <option value="මේෂ">මේෂ</option>
                <option value="වෘෂභ">වෘෂභ</option>
                <option value="මිථුන">මිථුන</option>
                <option value="කටක">කටක</option>
                <option value="සිංහ">සිංහ</option>
                <option value="කන්‍යා">කන්‍යා</option>
                <option value="තුලා">තුලා</option>
                <option value="වෘශ්චික">වෘශ්චික</option>
                <option value="ධනු">ධනු</option>
                <option value="මකර">මකර</option>
                <option value="කුම්භ">කුම්භ</option>
                <option value="මීන">මීන</option>
            </select>
        </div>

        <button class="btn-cta" id="findBtn">සොයන්න</button>
        
        <div id="errorDisplay" class="error-message"></div>

        <div id="results" class="results-container">
            
            <div id="mainResultDisplay" class="main-result-box" style="display: none;">
                </div>

            <div id="firstLetterResultSection" class="result-box">
                <h2 class="secondary-title" id="firstLetterTitle">ජන්මයාගේ මුලකුර</h2>
                <div class="result-row"><span class="result-label">නැකත</span> <span class="result-value" id="resNakatha">-</span></div>
                <div class="result-row"><span class="result-label">නැකැත් පාදය</span> <span class="result-value" id="resPada">-</span></div>
                <div class="result-row"><span class="result-label">උපන් නැකතට</span> <span class="result-value" id="resNakathCompatibility">-</span></div>
                <div class="result-row"><span class="result-label">පක්ෂියා</span> <span class="result-value" id="resBird">-</span></div>
                <div class="result-row"><span class="result-label">ජන්ම පක්ෂියාට</span> <span class="result-value" id="resBirdCompatibility">-</span></div>
                <div class="result-row"><span class="result-label">දවස</span> <span class="result-value" id="resDay">-</span></div>
                <div class="result-row"><span class="result-label">රාශිය</span> <span class="result-value" id="resRashi">-</span></div>
                <div class="result-row"><span class="result-label">ග්‍රහයා</span> <span class="result-value" id="resPlanet">-</span></div>
                <div class="result-row"><span class="result-label">භූත ගුණය</span> <span class="result-value" id="resBhootha">-</span></div>
                <div class="result-row"><span class="result-label">ජන්මයාට භූත ගුණය</span> <span class="result-value" id="resBhoothaComp">-</span></div>
            </div>

            <h2 class="secondary-title">ගණ පිහිටුවීම</h2>
            <div id="ganaSection" class="result-box"></div>

            <h2 class="secondary-title" id="svaraTitle" style="display:none;">ස්වර වේධ පරීක්ෂාව</h2>
            <div id="svaraVedhaSection" class="svara-vedha-box" style="display:none;"></div>

        </div>
    </div>

    <footer>
        &copy; <span id="year"></span> Suba Namak | Astro Jayamaga. All Rights Reserved.
    </footer>

    <script>
        // ==========================================
        // UTILS
        // ==========================================
        function toggleInfo() {
            const infoBox = document.getElementById('nameInfoBox');
            infoBox.style.display = (infoBox.style.display === 'block') ? 'none' : 'block';
        }

        // ==========================================
        // 1. CONVERTER LOGIC
        // ==========================================
        function buildFullMap() {
             const baseConsonants = { 'k': 'ක', 'kh': 'ඛ', 'g': 'ග', 'gh': 'ඝ', 'ch': 'ච', 'chh': 'ඡ', 'j': 'ජ', 'th': 'ත', 'thh': 'ථ', 'd': 'ඩ', 'dh': 'ද', 'q': 'ද', 'dhh': 'ධ', 'n': 'න', 'N': 'ණ', 'p': 'ප', 'ph': 'ඵ', 'b': 'බ', 'bh': 'භ', 'B': 'ඹ', 'm': 'ම', 'y': 'ය', 'r': 'ර', 'l': 'ල', 'L': 'ළ', 'v': 'ව', 'w': 'ව', 's': 'ස', 'sh': 'ශ', 'Sh': 'ෂ', 'S': 'ෂ', 'h': 'හ', 'f': 'ෆ', 't': 'ට', 'c': 'ස', 'D': 'ඪ', 'T': 'ඨ', 'C': 'ස', 'F': 'ෆ', 'G': 'ඝ', 'H': 'හ', 'J': 'ජ', 'K': 'ඛ', 'M': 'ම', 'P': 'ඵ', 'Q': 'ධ', 'V': 'ව', 'W': 'ව', 'Y': 'ය', 'zga': 'ඟ', 'zja': 'ඦ', 'zda': 'ඬ', 'zdha': 'ඳ', 'zqa': 'ඳ', 'zk': 'ඤ', 'zh': 'ඥ', 'X': 'ඞ' };
             const pillaChars = { 'a': '', 'aa': 'ා', 'A': 'ැ', 'Aa': 'ෑ', 'AA': 'ෑ', 'i': 'ි', 'ii': 'ී', 'u': 'ු', 'uu': 'ූ', 'R': 'ෘ', 'Ru': 'ෲ', 'e': 'ෙ', 'ee': 'ේ', 'ai': 'ෛ', 'o': 'ො', 'oo': 'ෝ', 'au': 'ෞ', 'ou': 'ෞ', 'H': 'ඃ' };
             const baseVowels = { 'a': 'අ', 'aa': 'ආ', 'A': 'ඇ', 'Aa': 'ඈ', 'AA': 'ඈ', 'i': 'ඉ', 'ii': 'ඊ', 'u': 'උ', 'U': 'උ', 'uu': 'ඌ', 'R': 'ඍ', 'Ru': 'ඎ', 'e': 'එ', 'E': 'එ', 'ee': 'ඒ', 'ai': 'ඓ', 'I': 'ඓ', 'o': 'ඔ', 'O': 'ඔ', 'oo': 'ඕ', 'au': 'ඖ', 'ou': 'ඖ' };
             let consonantBlocks = { ...baseConsonants };
             Object.assign(consonantBlocks, { 'tt': 'ට්ට', 'dd': 'ඩ්ඩ', 'nn': 'න්න', 'mm': 'ම්ම', 'll': 'ල්ල', 'pp': 'ප්ප' });
             for (const key in baseConsonants) {
                 if (key !== 'y') consonantBlocks[key + 'y'] = baseConsonants[key] + '්‍ය';
                 if (key !== 'r') consonantBlocks[key + 'r'] = baseConsonants[key] + '්‍ර';
             }
             let fullMap = { ...baseVowels, 'Lu': 'ළු', '.': '෴', 'x': 'ං', 'z': '' };
             for (const blockKey in consonantBlocks) {
                 const blockValue = consonantBlocks[blockKey];
                 fullMap[blockKey] = blockValue + '්';
                 for (const pillaKey in pillaChars) {
                     if (pillaKey === 'a') fullMap[blockKey + 'a'] = blockValue;
                     else fullMap[blockKey + pillaKey] = blockValue + pillaChars[pillaKey];
                 }
             }
             return fullMap;
        }
        const conversionMap = buildFullMap();
        const sortedKeys = Object.keys(conversionMap).sort((a, b) => b.length - a.length);
        function convertSinglishToSinhala(text) {
             const words = text.split(' ');
             return words.map(word => {
                 if (word.length === 0) return '';
                 let converted = '', i = 0;
                 while (i < word.length) {
                     let matchFound = false;
                     for (const key of sortedKeys) {
                         if (word.substring(i, i + key.length) === key) { converted += conversionMap[key]; i += key.length; matchFound = true; break; }
                     }
                     if (!matchFound) { converted += word[i]; i++; }
                 }
                 return converted;
             }).join(' ');
        }

        // ==========================================
        // 2. LETTER DETAILS
        // ==========================================
        const definitions = [
            { key: 'අ', n: 'කැති', p: 1 }, { key: 'ආ', n: 'කැති', p: 1 }, { key: 'ඉ', n: 'කැති', p: 2 }, { key: 'ඊ', n: 'කැති', p: 2 },
            { key: 'උ', n: 'කැති', p: 3 }, { key: 'ඌ', n: 'කැති', p: 3 }, { key: 'එ', n: 'කැති', p: 4 }, { key: 'ඒ', n: 'කැති', p: 4 },
            { key: 'ඔ', n: 'රෙහෙණ', p: 1 }, { key: 'ඕ', n: 'රෙහෙණ', p: 1 }, { key: 'ඞ', n: 'අද', p: 3 },
            { key: 'ක', n: 'මුවසිරස', p: 3 }, { key: 'කි', n: 'මුවසිරස', p: 4 }, { key: 'කී', n: 'මුවසිරස', p: 4 },
            { key: 'කු', n: 'අද', p: 1 }, { key: 'කූ', n: 'අද', p: 1 }, { key: 'කෙ', n: 'පුනාවස', p: 1 }, { key: 'කේ', n: 'පුනාවස', p: 1 }, { key: 'කො', n: 'පුනාවස', p: 2 }, { key: 'කෝ', n: 'පුනාවස', p: 2 },
            { key: 'ච', n: 'රේවතී', p: 3 }, { key: 'චි', n: 'රේවතී', p: 4 }, { key: 'චී', n: 'රේවතී', p: 4 }, { key: 'චු', n: 'අස්විද', p: 1 }, { key: 'චූ', n: 'අස්විද', p: 1 }, { key: 'චෙ', n: 'අස්විද', p: 2 }, { key: 'චේ', n: 'අස්විද', p: 2 }, { key: 'චො', n: 'අස්විද', p: 3 }, { key: 'චෝ', n: 'අස්විද', p: 3 },
            { key: 'ඡ', n: 'අද', p: 4 }, { key: 'ට', n: 'පුවපල්', p: 2 }, { key: 'ටි', n: 'පුවපල්', p: 3 }, { key: 'ටු', n: 'පුවපල්', p: 4 }, { key: 'ටෙ', n: 'උත්‍රපල්', p: 1 }, { key: 'ටො', n: 'උත්‍රපල්', p: 2 },
            { key: 'ඨ', n: 'හත', p: 4 }, { key: 'ත', n: 'සා', p: 4 }, { key: 'ති', n: 'විසා', p: 1 }, { key: 'තී', n: 'විසා', p: 1 }, { key: 'තු', n: 'විසා', p: 2 }, { key: 'තූ', n: 'විසා', p: 2 }, { key: 'තෙ', n: 'විසා', p: 3 }, { key: 'තේ', n: 'විසා', p: 3 }, { key: 'තො', n: 'විසා', p: 4 }, { key: 'තෝ', n: 'විසා', p: 4 },
            { key: 'ථ', n: 'උත්‍රපුටුප', p: 2 }, { key: 'ප', n: 'උත්‍රපල්', p: 3 }, { key: 'පි', n: 'උත්‍රපල්', p: 4 }, { key: 'පු', n: 'හත', p: 1 }, { key: 'පෙ', n: 'සිත', p: 1 }, { key: 'පො', n: 'සිත', p: 2 },
            { key: 'ග', n: 'දෙනට', p: 1 }, { key: 'ගි', n: 'දෙනට', p: 2 }, { key: 'ගු', n: 'දෙනට', p: 3 }, { key: 'ගෙ', n: 'දෙනට', p: 4 }, { key: 'ගො', n: 'සියාවස', p: 1 },
            { key: 'ඝ', n: 'අද', p: 2 }, { key: 'ජ', n: 'උත්‍රසල', p: 3 }, { key: 'ජි', n: 'උත්‍රසල', p: 4 }, { key: 'ජු', n: 'සුවණ', p: 1 }, { key: 'ජෙ', n: 'සුවණ', p: 2 }, { key: 'ජො', n: 'සුවණ', p: 3 },
            { key: 'ඣ', n: 'උත්‍රපුටුප', p: 3 }, { key: 'ඤ', n: 'උත්‍රපුටුප', p: 4 }, { key: 'ඩ', n: 'පුෂ', p: 4 }, { key: 'ඩි', n: 'අස්ලිස', p: 1 }, { key: 'ඩු', n: 'අස්ලිස', p: 2 }, { key: 'ඩෙ', n: 'අස්ලිස', p: 3 }, { key: 'ඩො', n: 'අස්ලිස', p: 4 },
            { key: 'ඪ', n: 'පුවසල', p: 4 }, { key: 'ද', n: 'පුවපුටුප', p: 3 }, { key: 'දි', n: 'පුවපුටුප', p: 4 }, { key: 'දු', n: 'උත්‍රපුටුප', p: 1 }, { key: 'දෙ', n: 'රේවතී', p: 1 }, { key: 'දො', n: 'රේවතී', p: 2 },
            { key: 'ධ', n: 'පුවසල', p: 2 }, { key: 'බ', n: 'මුල', p: 3 }, { key: 'බි', n: 'මුල', p: 4 }, { key: 'බු', n: 'පුවසල', p: 1 }, { key: 'බෙ', n: 'උත්‍රසල', p: 1 }, { key: 'බො', n: 'උත්‍රසල', p: 2 },
            { key: 'න', n: 'අනුර', p: 1 }, { key: 'නි', n: 'අනුර', p: 2 }, { key: 'නු', n: 'අනුර', p: 3 }, { key: 'නෙ', n: 'අනුර', p: 4 }, { key: 'නො', n: 'දෙට', p: 1 },
            { key: 'ණ', n: 'හත', p: 3 }, { key: 'ම', n: 'මා', p: 1 }, { key: 'මි', n: 'මා', p: 2 }, { key: 'මු', n: 'මා', p: 3 }, { key: 'මෙ', n: 'මා', p: 4 }, { key: 'මො', n: 'පුවපල්', p: 1 },
            { key: 'ය', n: 'දෙට', p: 2 }, { key: 'යි', n: 'දෙට', p: 3 }, { key: 'යු', n: 'දෙට', p: 4 }, { key: 'යෙ', n: 'මුල', p: 1 }, { key: 'යො', n: 'මුල', p: 2 },
            { key: 'ර', n: 'සිත', p: 3 }, { key: 'රි', n: 'සිත', p: 4 }, { key: 'රු', n: 'සා', p: 1 }, { key: 'රෙ', n: 'සා', p: 2 }, { key: 'රො', n: 'සා', p: 3 },
            { key: 'ල', n: 'අස්විද', p: 4 }, { key: 'ලි', n: 'බෙරණ', p: 1 }, { key: 'ලු', n: 'බෙරණ', p: 2 }, { key: 'ලෙ', n: 'බෙරණ', p: 3 }, { key: 'ලො', n: 'බෙරණ', p: 4 },
            { key: 'ව', n: 'රෙහෙණ', p: 2 }, { key: 'වි', n: 'රෙහෙණ', p: 3 }, { key: 'වු', n: 'රෙහෙණ', p: 4 }, { key: 'වෙ', n: 'මුවසිරස', p: 1 }, { key: 'වො', n: 'මුවසිරස', p: 2 },
            { key: 'ස', n: 'සියාවස', p: 2 }, { key: 'සි', n: 'සියාවස', p: 3 }, { key: 'සු', n: 'සියාවස', p: 4 }, { key: 'සෙ', n: 'පුවපුටුප', p: 1 }, { key: 'සො', n: 'පුවපුටුප', p: 2 },
            { key: 'ෂ', n: 'හත', p: 2 }, { key: 'ශ', n: 'සුවණ', p: 4 }, { key: 'හ', n: 'පුනාවස', p: 3 }, { key: 'හි', n: 'පුනාවස', p: 4 }, { key: 'හු', n: 'පුෂ', p: 1 }, { key: 'හෙ', n: 'පුෂ', p: 2 }, { key: 'හො', n: 'පුෂ', p: 3 }
        ];

        function getLetterDetails(fullWord) {
            if (!fullWord) return null;
            let firstUnit = fullWord.charAt(0);
            if (fullWord.length > 1) {
                const nextChar = fullWord.charAt(1);
                if (['ා','ැ','ෑ','ි','ී','ු','ූ','ෘ','ෙ','ේ','ෛ','ො','ෝ','ෞ','්','ං'].includes(nextChar)) firstUnit += nextChar;
            }
            const findExact = (key) => definitions.find(d => d.key === key);
            let match = findExact(firstUnit);
            if (match) return match;
            const shortMap = { 'ා': '', 'ෑ': 'ැ', 'ී': 'ි', 'ූ': 'ු', 'ේ': 'ෙ', 'ෝ': 'ො' };
            const baseChar = fullWord.charAt(0);
            const vowelChar = fullWord.length > 1 ? fullWord.charAt(1) : '';
            let normalizedUnit = null;
            if (shortMap[vowelChar] !== undefined) normalizedUnit = baseChar + shortMap[vowelChar];
            else if (shortMap[vowelChar] === undefined && ['ැ','ි','ු','ෙ','ො'].includes(vowelChar)) normalizedUnit = baseChar + vowelChar;
            if (normalizedUnit) {
                match = findExact(normalizedUnit);
                if (match) return match;
            }
            return findExact(baseChar);
        }

        // BHOOTHA LOGIC
        const bhoothaMap = { "පඨවි": ["අ","ආ","ක","ව","ල","ළ"], "ආපෝ": ["ඉ","ඊ","හ","ම","ට","ඩ"], "තේජෝ": ["උ","ඌ","ප","ර","ත"], "වායෝ": ["එ","ඒ","න","බ","ය","ජ"], "ආකාශ": ["ඔ","ඕ","ග","ස","ද","ච"] };
        const lagnaBhoothaRules = {
            "මේෂ": { good: ["තේජෝ", "වායෝ"], bad: ["පඨවි"] }, "වෘෂභ": { good: ["පඨවි", "ආපෝ"], bad: ["තේජෝ", "වායෝ"] },
            "මිථුන": { good: ["වායෝ", "පඨවි"], bad: ["ආපෝ", "තේජෝ"] }, "කටක": { good: ["ආපෝ", "පඨවි"], bad: ["වායෝ"] },
            "සිංහ": { good: ["තේජෝ", "වායෝ"], bad: ["පඨවි"] }, "කන්‍යා": { good: ["පඨවි", "ආපෝ"], bad: ["තේජෝ"] },
            "තුලා": { good: ["ආකාශ"], bad: [] }, "වෘශ්චික": { good: ["ආපෝ", "තේජෝ"], bad: ["වායෝ", "පඨවි"] },
            "ධනු": { good: ["තේජෝ", "ආකාශ"], bad: ["පඨවි"] }, "මකර": { good: ["පඨවි", "වායෝ"], bad: ["ආපෝ", "තේජෝ"] },
            "කුම්භ": { good: ["වායෝ", "තේජෝ"], bad: ["ආපෝ"] }, "මීන": { good: ["ආපෝ", "ආකාශ"], bad: ["වායෝ"] }
        };
        function getBhoothaForLetter(letter) {
            const baseChar = letter.charAt(0);
            for (const [bhootha, letters] of Object.entries(bhoothaMap)) if (letters.includes(baseChar)) return bhootha + " භූතය";
            return null;
        }
        function getBhoothaStatus(letterBhootha, lagnaya) {
            const bName = letterBhootha.replace(" භූතය", "").trim();
            const rules = lagnaBhoothaRules[lagnaya];
            if (!rules) return null;
            if (rules.good.includes(bName)) return { text: "ඉතා සුභයි", class: "status-good" };
            else if (rules.bad.includes(bName)) return { text: "අසුභයි", class: "status-bad" };
            return { text: "සුභයි", class: "status-good" };
        }

        // HELPERS
        function getNakathCompatibility(userNakatha, letterNakatha) {
            const allNakatha = ["අස්විද", "බෙරණ", "කැති", "රෙහෙණ", "මුවසිරස", "අද", "පුනාවස", "පුෂ", "අස්ලිස", "මා", "පුවපල්", "උත්‍රපල්", "හත", "සිත", "සා", "විසා", "අනුර", "දෙට", "මුල", "පුවසල", "උත්‍රසල", "සුවණ", "දෙනට", "සියාවස", "පුවපුටුප", "උත්‍රපුටුප", "රේවතී"];
            const userIndex = allNakatha.indexOf(userNakatha);
            const letterIndex = allNakatha.indexOf(letterNakatha);
            if (userIndex === -1 || letterIndex === -1) return null;
            const diff = (letterIndex - userIndex + 27) % 27;
            const resultIndex = diff % 9;
            const results = [{name:"ජන්ම",status:"සුභයි",color:"good"}, {name:"සම්පත්",status:"සුභයි",color:"good"}, {name:"විපත්",status:"අසුභයි",color:"bad"}, {name:"ක්ෂේම",status:"සුභයි",color:"good"}, {name:"ප්‍රත්‍යාරී",status:"අසුභයි",color:"bad"}, {name:"සාධක",status:"සුභයි",color:"good"}, {name:"වධ",status:"අසුභයි",color:"bad"}, {name:"මෛත්‍රී",status:"සුභයි",color:"good"}, {name:"පරම මෛත්‍රී",status:"සුභයි",color:"good"}];
            return results[resultIndex];
        }
        function getVowelSound(name) {
            const char1 = name.charAt(0);
            if (['අ','ආ','ඇ','ඈ','ඉ','ඊ','උ','ඌ','එ','ඒ','ඔ','ඕ','ඓ','ඖ'].includes(char1)) return char1;
            const piliMap = { 'ා':'ආ', 'ැ':'ඇ', 'ෑ':'ඈ', 'ි':'ඉ', 'ී':'ඊ', 'ු':'උ', 'ූ':'ඌ', 'ෙ':'එ', 'ේ':'ඒ', 'ො':'ඔ', 'ෝ':'ඕ', 'ෛ':'ඓ', 'ෞ':'ඖ', 'ෘ':'උ', 'ෲ':'ඌ' };
            if (name.length > 1 && piliMap[name.charAt(1)]) return piliMap[name.charAt(1)];
            return 'අ';
        }
        function getBird(vowel) {
            if (['අ','ආ','ඇ','ඈ'].includes(vowel)) return 'භේරුණ්ඩ පක්ෂියා';
            if (['ඉ','ඊ','ඓ'].includes(vowel)) return 'පිංගල පක්ෂියා';
            if (['උ','ඌ','ෘ'].includes(vowel)) return 'කාක පක්ෂියා';
            if (['එ','ඒ'].includes(vowel)) return 'කුක්කුට පක්ෂියා';
            if (['ඔ','ඕ','ඖ'].includes(vowel)) return 'මයුර පක්ෂියා';
            return null;
        }
        function getNakathaBird(nakatha) {
            const groups = [{birds:['අස්විද','බෙරණ','කැති','රෙහෙණ','මුවසිරස'],name:'භේරුණ්ඩ පක්ෂියා'}, {birds:['අද','පුනාවස','පුෂ','අස්ලිස','මා','පුවපල්'],name:'පිංගල පක්ෂියා'}, {birds:['උත්‍රපල්','හත','සිත','සා','විසා'],name:'කාක පක්ෂියා'}, {birds:['අනුර','දෙට','මුල','පුවසල','උත්‍රසල','සුවණ'],name:'කුක්කුට පක්ෂියා'}, {birds:['දෙනට','සියාවස','පුවපුටුප','උත්‍රපුටුප','රේවතී'],name:'මයුර පක්ෂියා'}];
            const found = groups.find(g => g.birds.includes(nakatha));
            return found ? found.name : null;
        }
        function getBirdCompatibility(birthBird, nameBird) {
            if (!birthBird || !nameBird) return null;
            if (birthBird === nameBird) return { status: "ඉතා සුභයි", type: "ජන්ම", color: "good" };
            const map = { 'භේරුණ්ඩ පක්ෂියා': {friend:'පිංගල පක්ෂියා', enemy:'කාක පක්ෂියා'}, 'පිංගල පක්ෂියා': {friend:'භේරුණ්ඩ පක්ෂියා', enemy:'කුක්කුට පක්ෂියා'}, 'කාක පක්ෂියා': {friend:'කුක්කුට පක්ෂියා', enemy:'භේරුණ්ඩ පක්ෂියා'}, 'කුක්කුට පක්ෂියා': {friend:'කාක පක්ෂියා', enemy:'පිංගල පක්ෂියා'}, 'මයුර පක්ෂියා': {friend: null, enemy: null} };
            if (birthBird === 'මයුර පක්ෂියා') return { status: "ඉතා සුභයි", type: "මිතුරු", color: "good" };
            if (map[birthBird].friend === nameBird) return { status: "ඉතා සුභයි", type: "මිතුරු", color: "good" };
            if (map[birthBird].enemy === nameBird) return { status: "අසුභයි", type: "සතුරු", color: "bad" };
            return { status: "සුභයි", type: "උදාසීන", color: "good" };
        }
        function getAstrologyDetails(firstChar) {
            const days = [{d:"සඳුදා",chars:"යරලවශෂසහළ"}, {d:"අඟහරුවාදා",chars:"කබගඝඞ"}, {d:"බදාදා",chars:"ටඨඩඪණ"}, {d:"බ්‍රහස්පතින්දා",chars:"තථදධන"}, {d:"සිකුරාදා",chars:"චඡජඣඤ"}, {d:"සෙනසුරාදා",chars:"පඵබභම"}, {d:"ඉරිදා",chars:"අඉඋඑඔ"}];
            const rashis = [{r:"මේෂ",chars:"අආශ"}, {r:"වෘෂභ",chars:"ඉඊඋෂ"}, {r:"මිථුන",chars:"ඌඍඎස"}, {r:"කටක",chars:"ගඝඑහ"}, {r:"සිංහ",chars:"ඓඔඖළ"}, {r:"කන්‍යා",chars:"අංඅඃ"}, {r:"තුලා",chars:"කඛගඝඞ"}, {r:"වෘශ්චික",chars:"චඡජඣඤ"}, {r:"ධනු",chars:"ටඨඩඪණ"}, {r:"මකර",chars:"තථදධන"}, {r:"කුම්භ",chars:"පඵබභම"}, {r:"මීන",chars:"යරලව"}];
            const planets = [{p:"රවි",chars:"අඉඋඑඔ"}, {p:"චන්ද්‍ර",chars:"යරලවසහළ"}, {p:"කුජ",chars:"කබගඝඞ"}, {p:"බුධ",chars:"ටඨඩඪණ"}, {p:"ගුරු",chars:"තථදධන"}, {p:"සිකුරු",chars:"චඡජඣඤ"}, {p:"ශනි",chars:"පඵබභම"}];
            const check = (list, key) => { for(let item of list) if(item.chars.includes(key)) return item[Object.keys(item)[0]]; return null; };
            return { day: check(days, firstChar), rashi: check(rashis, firstChar), planet: check(planets, firstChar) };
        }

        // ==========================================
        // 3. GANA LOGIC
        // ==========================================
        const ganaData = {
            "+++": { ganaStatus: "සුභයි ✅", ganaName: "ම - භූමි ගණය", adhipathi: "බුධ", nakatha: "සුවණ", prathiphala: "ජය, සම්පත්, ලාභ" },
            "---": { ganaStatus: "සුභයි ✅", ganaName: "න - දේව ගණය", adhipathi: "ගුරු", nakatha: "දෙට", prathiphala: "බලය, තේජස, ආයුෂ" },
            "+--": { ganaStatus: "සුභයි ✅", ganaName: "බ - චන්ද්‍ර ගණය", adhipathi: "චන්ද්‍ර", nakatha: "මුවසිරස", prathiphala: "සෙත, යසස්, නුවණ" },
            "-++": { ganaStatus: "සුභයි ✅", ganaName: "ය - ජල ගණය", adhipathi: "ශුක්‍ර", nakatha: "සියාවස", prathiphala: "ආයුෂ, ධෛර්‍යය, දියුණුව" },
            "--+": { ganaStatus: "අසුභයි ⭕", ganaName: "ස - වායු ගණය", adhipathi: "ශනි", nakatha: "සා", prathiphala: "විකල් වීම, පිටුවහල් කිරීම" },
            "++-": { ganaStatus: "අසුභයි ⭕", ganaName: "ත - ආකාශ ගණය", adhipathi: "රාහු", nakatha: "බෙරණ", prathiphala: "ධන හානි, විනාශය" },
            "-+-": { ganaStatus: "අසුභයි ⭕", ganaName: "ජ - සූර්ය ගණය", adhipathi: "රවි", nakatha: "පුනාවස", prathiphala: "රෝදුක්, කැක්කුම්" },
            "+-+": { ganaStatus: "අසුභයි ⭕", ganaName: "ර - අග්නි ගණය", adhipathi: "කුජ", nakatha: "කැති", prathiphala: "දැඩි ශෝක, මරණ බිය" }
        };
        const HAL='්', BINDUWA='ං', YANSAYA='්‍ය', RAKARANSAYA='්‍ර';
        const VOWEL_SIGNS=['ා','ැ','ෑ','ි','ී','ු','ූ','ෘ','ෲ','ෙ','ේ','ෛ','ො','ෝ','ෞ'];
        const CONSONANTS="කඛගඝචඡජඣඤටඨඩඪණතථදධනපඵබභමඹයරලවශෂසහළෆඟඦඬඳඥ";
        const VOWELS="අආඇඈඉඊඋඌඍඎඑඒඓඔඕඖ";

        function getSyllables(name) {
            const cleanName = name.replace(/\s+/g, '');
            const tokenize = (str) => {
                const tokens = []; let i = 0;
                while (i < str.length) {
                    const char = str[i], next = str[i + 1];
                    if (VOWELS.includes(char)) { tokens.push(char); i++; }
                    else if (CONSONANTS.includes(char)) {
                        if (next === HAL) { tokens.push(char + HAL); i += 2; }
                        else if (next === YANSAYA) { tokens.push(char + HAL); tokens.push('ය'); i += 2; }
                        else if (next === RAKARANSAYA) { tokens.push(char + HAL); tokens.push('ර'); i += 2; }
                        else if (VOWEL_SIGNS.includes(next)) { tokens.push(char + next); i += 2; }
                        else { tokens.push(char); i++; }
                    } else if (char === BINDUWA) { tokens.push(char); i++; }
                    else { i++; }
                } return tokens;
            };
            const syllabify = (tokens) => {
                if (!tokens.length) return [];
                const syllables = []; let currentSyllable = tokens.shift();
                while (tokens.length > 0) {
                    const nextToken = tokens[0];
                    if (nextToken.endsWith(HAL)) { currentSyllable += nextToken; tokens.shift(); }
                    else if (nextToken === BINDUWA) { currentSyllable += nextToken; tokens.shift(); syllables.push(currentSyllable); currentSyllable = tokens.shift() || ''; }
                    else { syllables.push(currentSyllable); currentSyllable = tokens.shift(); }
                }
                if (currentSyllable) syllables.push(currentSyllable);
                return syllables;
            };
            return syllabify(tokenize(cleanName));
        }
        function getGanaType(syllable) {
            if (!syllable) return '';
            if (syllable.includes('ෘ') || syllable.includes('ෲ')) return '+';
            if (['ා','ෑ','ී','ූ','ේ','ෝ'].some(v => syllable.includes(v))) return '+';
            if (syllable.endsWith(HAL)) return '+';
            if (syllable.includes(BINDUWA) || syllable.includes('ඃ')) return '+';
            if (VOWELS.includes(syllable) && 'ආඇඈඊඌඒඕඖ'.includes(syllable)) return '+';
            return '-';
        }

        // SVARA VEDHA DATA
        const svaraOpposition = { 'අ':'උ', 'උ':'අ', 'ආ':'ඌ', 'ඌ':'ආ', 'ඉ':['එ','ඒ'], 'ඊ':['ඔ','ඕ'], 'එ':'ඉ', 'ඒ':'ඉ', 'ඔ':'ඊ', 'ඕ':'ඊ' };
        const relevantVowels = ['අ','ආ','ඉ','ඊ','උ','ඌ','එ','ඒ','ඔ','ඕ'];

        // ==========================================
        // 5. EVENT HANDLERS (MAIN)
        // ==========================================
        document.getElementById('year').textContent = new Date().getFullYear();

        document.getElementById('nameInput').addEventListener('input', function() {
            const raw = this.value;
            const previewEl = document.getElementById('sinhalaPreview');
            let convertedText = raw;
            if (/^[a-zA-Z\s]+$/.test(raw)) convertedText = convertSinglishToSinhala(raw);
            if (convertedText && convertedText.trim() !== "") {
                previewEl.textContent = convertedText;
                previewEl.classList.add('preview-active');
            } else {
                previewEl.textContent = "සිංහල නම මෙතැනින් දිස්වේ >>";
                previewEl.classList.remove('preview-active');
            }
        });

        document.getElementById('findBtn').addEventListener('click', function() {
            let nameInputRaw = document.getElementById('nameInput').value;
            const nakatha = document.getElementById('nekatha').value;
            const lagnaya = document.getElementById('lagnaya').value;
            const errorDiv = document.getElementById('errorDisplay');
            const resultsDiv = document.getElementById('results');
            const mainResultDisplay = document.getElementById('mainResultDisplay');
            
            errorDiv.style.display = 'none';
            resultsDiv.style.display = 'none';
            mainResultDisplay.style.display = 'none';

            if (!nameInputRaw || !nakatha || !lagnaya) {
                errorDiv.innerText = "කරුණාකර නම, නැකත සහ ලග්නය තෝරන්න.";
                errorDiv.style.display = 'block';
                return;
            }

            let name = nameInputRaw;
            if (/^[a-zA-Z\s]+$/.test(nameInputRaw)) name = convertSinglishToSinhala(nameInputRaw);
            const cleanName = name.replace(/\s+/g, '');
            const words = name.trim().split(/\s+/);

            if (words.length > 3) { errorDiv.innerText = "කරුණාකර වචන 3කට වඩා වැඩි නොවන නමක් ඇතුළත් කරන්න."; errorDiv.style.display = 'block'; return; }
            for (let i = 0; i < words.length; i++) { if (words[i].length > 12) { errorDiv.innerText = `"${words[i]}" යන වචනය සඳහා අකුරු 12ක් ඉක්මවා ඇත.`; errorDiv.style.display = 'block'; return; } }
            if (cleanName.length < 2) { errorDiv.innerText = "කරුණාකර අක්ෂර දෙකක් හෝ වැඩි ගණනක් ඇතුළත් කරන්න."; errorDiv.style.display = 'block'; return; }

            // === SCORING INIT ===
            let totalScore = 0;

            // --- 1. First Letter Analysis ---
            const firstLetterDetails = getLetterDetails(words[0]);
            let nComp = null;
            
            if (firstLetterDetails) {
                document.getElementById('resNakatha').innerText = firstLetterDetails.n;
                document.getElementById('resPada').innerText = firstLetterDetails.p + " පාදය";
                document.getElementById('firstLetterTitle').innerText = "ජන්මයාගේ මුලකුර (" + words[0].charAt(0) + ")";

                nComp = getNakathCompatibility(nakatha, firstLetterDetails.n);
                const nCompEl = document.getElementById('resNakathCompatibility');
                nCompEl.innerText = nComp.name + " (" + nComp.status + ")";
                nCompEl.className = "result-value " + (nComp.color === 'good' ? 'status-good' : 'status-bad');

                // SCORING: Nakatha
                if (["ජන්ම", "සම්පත්", "පරම මෛත්‍රී"].includes(nComp.name)) totalScore += 32;
                else if (["මෛත්‍රී", "ක්ෂේම", "සාධක"].includes(nComp.name)) totalScore += 20;

                const vowel = getVowelSound(words[0]);
                const nameBird = getBird(vowel);
                const birdEl = document.getElementById('resBird');
                birdEl.innerText = nameBird || "-";

                const birthBird = getNakathaBird(nakatha);
                const bCompEl = document.getElementById('resBirdCompatibility');
                if (nameBird && birthBird) {
                    const bComp = getBirdCompatibility(birthBird, nameBird);
                    bCompEl.innerText = bComp.type + " (" + bComp.status + ")";
                    bCompEl.className = "result-value " + (bComp.color === 'good' ? 'status-good' : 'status-bad');
                    
                    // SCORING: Bird
                    if (bComp.status.includes("ඉතා සුභයි")) totalScore += 10;
                    else if (bComp.status.includes("සුභයි")) totalScore += 7;
                } else {
                    bCompEl.innerText = "-";
                    bCompEl.className = "result-value";
                }

                const astro = getAstrologyDetails(words[0].charAt(0));
                document.getElementById('resDay').innerText = astro.day || "-";
                document.getElementById('resRashi').innerText = astro.rashi || "-";
                document.getElementById('resPlanet').innerText = astro.planet || "-";

                const bhootha = getBhoothaForLetter(words[0]);
                const resBhoothaEl = document.getElementById('resBhootha');
                const resBhoothaCompEl = document.getElementById('resBhoothaComp');
                if (bhootha) {
                    resBhoothaEl.innerText = bhootha;
                    const bStatus = getBhoothaStatus(bhootha, lagnaya);
                    if (bStatus) {
                        resBhoothaCompEl.innerText = bStatus.text;
                        resBhoothaCompEl.className = "result-value " + bStatus.class;
                        
                        // SCORING: Bhootha
                        if (bStatus.text.includes("ඉතා සුභයි")) totalScore += 8;
                        else if (bStatus.text.includes("සුභයි")) totalScore += 5;
                    } else {
                        resBhoothaCompEl.innerText = "-";
                    }
                    resBhoothaEl.parentElement.style.display = 'flex';
                    resBhoothaCompEl.parentElement.style.display = 'flex';
                } else {
                    resBhoothaEl.parentElement.style.display = 'none';
                    resBhoothaCompEl.parentElement.style.display = 'none';
                }
                document.getElementById('firstLetterResultSection').style.display = 'block';
            } else {
                document.getElementById('firstLetterResultSection').style.display = 'none';
            }

            // --- 2. Gana Analysis ---
            const ganaSection = document.getElementById('ganaSection');
            ganaSection.innerHTML = '';
            try {
                let syllables = getSyllables(cleanName);
                if (syllables.length === 0) throw new Error("No syllables");
                let finalSyllables = [...syllables];
                if (finalSyllables.length < 3) {
                    const repeater = [...syllables];
                    while (finalSyllables.length < 3) finalSyllables.push(...repeater);
                }
                const pattern = finalSyllables.slice(0, 3).map(getGanaType).join('');
                const gData = ganaData[pattern];

                if (gData) {
                    // SCORING: Gana Status
                    if (gData.ganaStatus.includes("සුභයි") && !gData.ganaStatus.includes("අසුභයි")) totalScore += 20;

                    const isAsubha = gData.ganaStatus.includes("අසුභයි");
                    const statusClass = isAsubha ? 'gana-bad' : 'gana-good';
                    const nameTextColor = isAsubha ? 'status-bad' : 'status-good';
                    const gNakathComp = getNakathCompatibility(nakatha, gData.nakatha);
                    
                    // SCORING: Gana Nakatha
                    if (gNakathComp) {
                        if (["ජන්ම", "සම්පත්", "පරම මෛත්‍රී"].includes(gNakathComp.name)) totalScore += 15;
                        else if (["මෛත්‍රී", "ක්ෂේම", "සාධක"].includes(gNakathComp.name)) totalScore += 10;
                    }

                    const gMatchHtml = gNakathComp ? 
                        `<div class="result-row" style="background:${gNakathComp.color==='good'?'#eaf7ec':'#fbe9e7'}; padding:10px; border-radius:5px; margin-top:10px;">
                            <span class="result-label">ජන්මයාගේ උපන් නැකතට:</span>
                            <span class="result-value ${gNakathComp.color==='good'?'status-good':'status-bad'}">${gNakathComp.name} (${gNakathComp.status})</span>
                         </div>` : '';

                    ganaSection.innerHTML = `
                        <div class="gana-header ${statusClass}">
                            ගණය: ${gData.ganaStatus}
                        </div>
                        <div class="result-row">
                            <span class="result-label">ගණය</span> 
                            <span class="result-value ${nameTextColor}" style="font-weight: 700; font-size: 1.1rem;">${gData.ganaName}</span>
                        </div>
                        <div class="result-row">
                            <span class="result-label">අක්ෂර විස්තර</span> 
                            <span class="result-value">
                                <strong>${finalSyllables.slice(0,3).join(' | ')}</strong><br>
                                <span class="akshara-visthara">${pattern.split('').join(' ')}</span>
                            </span>
                        </div>
                        <div class="result-row"><span class="result-label">අධිපති</span> <span class="result-value">${gData.adhipathi}</span></div>
                        <div class="result-row"><span class="result-label">හිමි නැකත</span> <span class="result-value">${gData.nakatha}</span></div>
                        <div class="result-row"><span class="result-label">ප්‍රතිඵල</span> <span class="result-value">${gData.prathiphala}</span></div>
                        ${gMatchHtml}
                    `;
                } else { ganaSection.innerHTML = '<p class="error-message" style="display:block">ගණය ගණනය කිරීමට නොහැක.</p>'; }
            } catch(e) { ganaSection.innerHTML = '<p class="error-message" style="display:block">දෝෂයක් ඇතිවිය.</p>'; }

            // --- 3. Svara Vedha Analysis ---
            const svaraSection = document.getElementById('svaraVedhaSection');
            const svaraTitle = document.getElementById('svaraTitle');

            if (words.length >= 2) {
                const vowel1 = getVowelSound(words[0]);
                const vowel2 = getVowelSound(words[1]);
                let svaraHeader = "", svaraClass = "", svaraResultText = "", isBad = false;

                if (!relevantVowels.includes(vowel1) || !relevantVowels.includes(vowel2)) isBad = false; 
                else if (
                    (Array.isArray(svaraOpposition[vowel1]) && svaraOpposition[vowel1].includes(vowel2)) ||
                    (Array.isArray(svaraOpposition[vowel2]) && svaraOpposition[vowel2].includes(vowel1)) ||
                    (svaraOpposition[vowel1] === vowel2)
                ) isBad = true;
                else isBad = false;

                // SCORING: Svara
                if (!isBad) totalScore += 15;

                if (isBad) { svaraHeader = "අසුභයි ⭕"; svaraClass = "svara-bad"; svaraResultText = "ස්වර වේධ වේ."; } 
                else { svaraHeader = "සුභයි ✅"; svaraClass = "svara-good"; svaraResultText = "ස්වර වේධ නොවේ."; }

                svaraSection.innerHTML = `
                    <div class="svara-header ${svaraClass}">${svaraHeader}</div>
                    <div class="result-row"><span class="result-label">පළමු නාමය (${words[0]})</span> <span class="result-value">${vowel1}</span></div>
                    <div class="result-row"><span class="result-label">දෙවන නාමය (${words[1]})</span> <span class="result-value">${vowel2}</span></div>
                    <div class="result-row" style="margin-top:10px; border-bottom:none;">
                        <span class="result-label" style="font-weight:700; color:#555;">නිගමනය:</span>
                        <span class="result-value" style="font-weight:700; ${isBad ? 'color:var(--error-color)' : 'color:var(--success-color)'}">${svaraResultText}</span>
                    </div>
                `;
                svaraSection.style.display = 'block';
                svaraTitle.style.display = 'block';
            } else {
                svaraSection.style.display = 'none';
                svaraTitle.style.display = 'none';
            }

            // --- FINAL SCORE DISPLAY ---
            let resultText = "";
            let themeClass = "";
            if (totalScore >= 80) { resultText = "ජන්මයාට ඉතා සුභයි ⭐"; themeClass = "theme-blue"; }
            else if (totalScore >= 60) { resultText = "ජන්මයාට සුභයි ✅"; themeClass = "theme-green"; }
            else if (totalScore >= 40) { resultText = "මධ්‍යමයි ➡️"; themeClass = "theme-yellow"; }
            else if (totalScore >= 20) { resultText = "ජන්මයාට අසුභයි ⭕"; themeClass = "theme-brown"; }
            else { resultText = "ජන්මයාට ඉතා අසුභයි ⭕"; themeClass = "theme-red"; }

            mainResultDisplay.className = "main-result-box " + themeClass;
            mainResultDisplay.innerHTML = `
                <div class="main-result-text">${resultText}</div>
            `;
            mainResultDisplay.style.display = 'block';

            resultsDiv.style.display = 'block';
            resultsDiv.scrollIntoView({ behavior: 'smooth' });
        });
    </script>
</body>
</html>

